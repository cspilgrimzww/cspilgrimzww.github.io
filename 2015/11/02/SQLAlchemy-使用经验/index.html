<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>SQLAlchemy ä½¿ç”¨ç»éªŒ | Weiwei Zhong&#39;s blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Weiwei Zhong's blog">
    <meta name="author" content="é’Ÿè”šè”š">
    <meta name="description" content="Tyrion" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Weiwei Zhong&#39;s blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    
    

    <!-- Custom stylesheet, (add custom styles here, always load last) -->
    <!-- Load our stylesheet for IE8 -->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- Google Webfonts (Monserrat 400/700, Open Sans 400/600) -->
    <link href='//fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <!-- Load our fonts individually if IE8+, to avoid faux bold & italic rendering -->
    <!--[if IE]>
    <link href='http://fonts.useso.com/css?family=Montserrat:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="http://www.nodebeginner.org/index-zh-cn.html" target="_BLANK" class="animsition-link">node</a></li>
                    
                        <li><a href="http://dillinger.io/" target="_BLANK" class="animsition-link">Online Markdown Editor</a></li>
                    
                        <li><a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_BLANK" class="animsition-link">A successful Git branching model</a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://blog.liqilei.com/" class="animsition-link">Qilei Li</a></li>
                    
                    <li><a href="http://go.kieran.top/" class="animsition-link">Kieran</a></li>
                    
                    <li><a href="http://pangjiuzala.github.io/" class="animsition-link">Xing Liu</a></li>
                    
                    <li><a href="http://www.changhuiyuan.com/" class="animsition-link">Huiyuan Chang</a></li>
                    
                    <li><a href="http://www.jianshu.com/users/2e5186b9dd1c/latest_articles" class="animsition-link">Ke Xu</a></li>
                    
                    <li><a href="http://45.55.234.101/resume/" class="animsition-link">resume</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/profile.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Weiwei Zhong's blog</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/cspilgrimzww" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->

        <!-- ============================ Hero Image =========================== -->

        <section id="hero" class="scrollme">
            <div class="container-fluid element-img" style="background: url(/img/bg_img.jpg) no-repeat center center fixed;background-size: cover">
                <div class="row">
                    <div class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-8 col-md-offset-2 vertical-align cover boost text-center">
                        <div class="center-me animateme" data-when="exit" data-from="0" data-to="0.6" data-opacity="0" data-translatey="100">
                            <div>
                            	
                                <h2>YOU'VE MADE A <span>BRAVE</span> DECISION, WELCOME.</h2>
                                <p></p>
				    			
                                <h2></h2>
                                <p>A LITTLE BIT MORE FAST,A LITTLE BIT MORE STRONGã€‚</p>
				    			

                            </div>
                        </div>
                    </div>
                    <!-- // .col-md-12 -->
                </div>
                <div class="herofade beige-dk"></div>
            </div>
        </section>

        <!-- Height spacing helper -->
        <div class="heightblock"></div>
        <!-- // End height spacing helper -->

        <!-- ============================ END Hero Image =========================== -->
      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2015-11-01T16:33:35.000Z" itemprop="datePublished">
          2015-11-02
      </time>
    
    
    | 
    <a href='/tags/Python-SQLAlchemy-æ•°æ®åº“/'>Python SQLAlchemy æ•°æ®åº“</a>
    
    
</span>
                <h1>SQLAlchemy ä½¿ç”¨ç»éªŒ</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>ä»¥ Debian/Ubuntu ä¸ºä¾‹ï¼ˆè¯·ç¡®ä¿æœ‰ç®¡ç†å‘˜æƒé™ï¼‰ï¼š</p>
<p>1.MySQL<br>apt-get install mysql-server<br>apt-get install mysql-client<br>apt-get install libmysqlclient15-dev<br>2.python-mysqldb<br>apt-get install python-mysqldb<br>easy_install<br>wget <a href="http://peak.telecommunity.com/dist/ez_setup.py" target="_blank" rel="external">http://peak.telecommunity.com/dist/ez_setup.py</a><br>python ez_setup.py<br>3.MySQL-Python<br>easy_install MySQL-Python<br>4.SQLAlchemy<br>easy_install SQLAlchemy</p>
<p>å¦‚æœæ˜¯ç”¨å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œé‡åˆ°é—®é¢˜å°± Google ä¸€ä¸‹å§ã€‚æˆ‘æ˜¯åœ¨ Mac OS X ä¸Šå¼€å‘çš„ï¼Œé€”ä¸­ä¹Ÿé‡åˆ°äº›é—®é¢˜ï¼Œä¸è¿‡å½“æ—¶æ²¡è®°ä¸‹æ¥â€¦â€¦<br>å€¼å¾—ä¸€æçš„æ˜¯æˆ‘ç”¨äº† MySQL-Python æ¥è¿ MySQLï¼Œå› ä¸ºä¸æ”¯æŒå¼‚æ­¥è°ƒç”¨ï¼Œæ‰€ä»¥å’Œ Tornado ä¸æ˜¯å¾ˆæ­ã€‚ä¸è¿‡æ€§èƒ½å…¶å®å¾ˆå¥½ï¼Œå› æ­¤ä»¥åå†å»ç ”ç©¶ä¸‹å…¶ä»–æ–¹æ¡ˆå§â€¦â€¦</p>
<p>è£…å¥½åå°±å¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼š</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy <span class="built_in">import</span> create_engine</span><br><span class="line">from sqlalchemy.orm <span class="built_in">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">DB_CONNECT_STRING</span> = 'mysql+mysqldb://root:<span class="number">123</span>@localhost/ooxx?<span class="attr">charset=utf8'</span></span><br><span class="line"><span class="attr">engine</span> = create_engine(DB_CONNECT_STRING, <span class="attr">echo=True)</span></span><br><span class="line"><span class="attr">DB_Session</span> = sessionmaker(<span class="attr">bind=engine)</span></span><br><span class="line"><span class="attr">session</span> = DB_Session()</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ DB_CONNECT_STRING å°±æ˜¯è¿æ¥æ•°æ®åº“çš„è·¯å¾„ã€‚â€œmysql+mysqldbâ€æŒ‡å®šäº†ä½¿ç”¨ MySQL-Python æ¥è¿æ¥ï¼Œâ€œrootâ€å’Œâ€œ123â€åˆ†åˆ«æ˜¯ç”¨æˆ·åå’Œå¯†ç ï¼Œâ€œlocalhostâ€æ˜¯æ•°æ®åº“çš„åŸŸåï¼Œâ€œooxxâ€æ˜¯ä½¿ç”¨çš„æ•°æ®åº“åï¼ˆå¯çœç•¥ï¼‰ï¼Œâ€œcharsetâ€æŒ‡å®šäº†è¿æ¥æ—¶ä½¿ç”¨çš„å­—ç¬¦é›†ï¼ˆå¯çœç•¥ï¼‰ã€‚<br>create_engine() ä¼šè¿”å›ä¸€ä¸ªæ•°æ®åº“å¼•æ“ï¼Œecho å‚æ•°ä¸º True æ—¶ï¼Œä¼šæ˜¾ç¤ºæ¯æ¡æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹å¯å…³é—­ã€‚<br>sessionmaker() ä¼šç”Ÿæˆä¸€ä¸ªæ•°æ®åº“ä¼šè¯ç±»ã€‚è¿™ä¸ªç±»çš„å®ä¾‹å¯ä»¥å½“æˆä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå®ƒåŒæ—¶è¿˜è®°å½•äº†ä¸€äº›æŸ¥è¯¢çš„æ•°æ®ï¼Œå¹¶å†³å®šä»€ä¹ˆæ—¶å€™æ‰§è¡Œ SQL è¯­å¥ã€‚ç”±äº SQLAlchemy è‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼ˆé»˜è®¤ 5 ä¸ªè¿æ¥ï¼‰ï¼Œå› æ­¤åˆå§‹åŒ–ä¸€ä¸ªä¼šè¯çš„å¼€é”€å¹¶ä¸å¤§ã€‚å¯¹ Tornado è€Œè¨€ï¼Œå¯ä»¥åœ¨ BaseHandler çš„ initialize() é‡Œåˆå§‹åŒ–ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.session = models.DB_Session()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_finish</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.session.close()</span><br></pre></td></tr></table></figure></p>
<p>å¯¹å…¶ä»– Web æœåŠ¡å™¨æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨ <a href="http://docs.sqlalchemy.org/en/rel_0_7/orm/session.html#sqlalchemy.orm.scoped_session" target="_blank" rel="external">sqlalchemy.orm.scoped_session</a>ï¼Œå®ƒèƒ½ä¿è¯æ¯ä¸ªçº¿ç¨‹è·å¾—çš„ session å¯¹è±¡éƒ½æ˜¯å”¯ä¸€çš„ã€‚ä¸è¿‡ Tornado æœ¬èº«å°±æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœä½¿ç”¨äº†å¼‚æ­¥æ–¹å¼ï¼Œå°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå› æ­¤æˆ‘å¹¶æ²¡ä½¿ç”¨å®ƒã€‚</p>
<p>æ‹¿åˆ° session åï¼Œå°±å¯ä»¥æ‰§è¡Œ SQL äº†ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.execute('<span class="keyword">create</span> <span class="keyword">database</span> abc<span class="string">')</span><br><span class="line">print session.execute('</span><span class="keyword">show</span> <span class="keyword">databases</span><span class="string">').fetchall()</span><br><span class="line">session.execute('</span><span class="keyword">use</span> abc<span class="string">')</span><br><span class="line"># å»º user è¡¨çš„è¿‡ç¨‹ç•¥</span><br><span class="line">print session.execute('</span><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span><span class="string">').first()</span><br><span class="line">print session.execute('</span><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">id</span> = :<span class="keyword">id</span><span class="string">', &#123;'</span><span class="keyword">id</span><span class="string">': 1&#125;).first()</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸è¿‡è¿™å’Œç›´æ¥ä½¿ç”¨ MySQL-Python æ²¡å•¥åŒºåˆ«ï¼Œæ‰€ä»¥å°±ä¸ä»‹ç»äº†ï¼›æˆ‘è¿˜æ˜¯å–œæ¬¢ ORM çš„æ–¹å¼ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘é‡‡ç”¨ SQLAlchemy çš„å”¯ä¸€åŸå› ã€‚</p>
<p>äºæ˜¯æ¥å®šä¹‰ä¸€ä¸ªè¡¨ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.types <span class="keyword">import</span> CHAR, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BaseModel = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    BaseModel.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_db</span><span class="params">()</span>:</span></span><br><span class="line">    BaseModel.metadata.drop_all(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'user'</span></span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(CHAR(<span class="number">30</span>)) <span class="comment"># or Column(String(30))</span></span><br><span class="line"></span><br><span class="line">init_db()</span><br></pre></td></tr></table></figure></p>
<p>declarative_base() åˆ›å»ºäº†ä¸€ä¸ª BaseModel ç±»ï¼Œè¿™ä¸ªç±»çš„å­ç±»å¯ä»¥è‡ªåŠ¨ä¸ä¸€ä¸ªè¡¨å…³è”ã€‚<br>ä»¥ User ç±»ä¸ºä¾‹ï¼Œå®ƒçš„ <strong>tablename</strong> å±æ€§å°±æ˜¯æ•°æ®åº“ä¸­è¯¥è¡¨çš„åç§°ï¼Œå®ƒæœ‰ id å’Œ name è¿™ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«ä¸ºæ•´å‹å’Œ 30 ä¸ªå®šé•¿å­—ç¬¦ã€‚Column è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å‚æ•°ï¼Œæˆ‘å°±ä¸è§£é‡Šäº†ã€‚<br>æœ€åï¼ŒBaseModel.metadata.create_all(engine) ä¼šæ‰¾åˆ° BaseModel çš„æ‰€æœ‰å­ç±»ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­å»ºç«‹è¿™äº›è¡¨ï¼›drop_all() åˆ™æ˜¯åˆ é™¤è¿™äº›è¡¨ã€‚</p>
<p>æ¥ç€å°±å¼€å§‹ä½¿ç”¨è¿™ä¸ªè¡¨å§ï¼š<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy import func, or_, not_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = User(name=<span class="string">'a'</span>)</span><br><span class="line">session.<span class="built_in">add</span>(user)</span><br><span class="line">user = User(name=<span class="string">'b'</span>)</span><br><span class="line">session.<span class="built_in">add</span>(user)</span><br><span class="line">user = User(name=<span class="string">'a'</span>)</span><br><span class="line">session.<span class="built_in">add</span>(user)</span><br><span class="line">user = User()</span><br><span class="line">session.<span class="built_in">add</span>(user)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line">query = session.query(User)</span><br><span class="line"><span class="keyword">print</span> query # æ˜¾ç¤ºSQL è¯­å¥</span><br><span class="line"><span class="keyword">print</span> query.statement # åŒä¸Š</span><br><span class="line"><span class="keyword">for</span> user in query: # éå†æ—¶æŸ¥è¯¢</span><br><span class="line">    <span class="keyword">print</span> user.name</span><br><span class="line"><span class="keyword">print</span> query.<span class="keyword">all</span>() # è¿”å›çš„æ˜¯ä¸€ä¸ªç±»ä¼¼åˆ—è¡¨çš„å¯¹è±¡</span><br><span class="line"><span class="keyword">print</span> query.<span class="keyword">first</span>().name # è®°å½•ä¸å­˜åœ¨æ—¶ï¼Œ<span class="keyword">first</span>() ä¼šè¿”å› None</span><br><span class="line"># <span class="keyword">print</span> query.one().name # ä¸å­˜åœ¨ï¼Œæˆ–æœ‰å¤šè¡Œè®°å½•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">filter</span>(User.id == <span class="number">2</span>).<span class="keyword">first</span>().name</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">get</span>(<span class="number">2</span>).name # ä»¥ä¸»é”®è·å–ï¼Œç­‰æ•ˆäºä¸Šå¥</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">filter</span>(<span class="string">'id = 2'</span>).<span class="keyword">first</span>().name # æ”¯æŒå­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">query2 = session.query(User.name)</span><br><span class="line"><span class="keyword">print</span> query2.<span class="keyword">all</span>() # æ¯è¡Œæ˜¯ä¸ªå…ƒç»„</span><br><span class="line"><span class="keyword">print</span> query2.limit(<span class="number">1</span>).<span class="keyword">all</span>() # æœ€å¤šè¿”å› <span class="number">1</span> æ¡è®°å½•</span><br><span class="line"><span class="keyword">print</span> query2.offset(<span class="number">1</span>).<span class="keyword">all</span>() # ä»ç¬¬ <span class="number">2</span> æ¡è®°å½•å¼€å§‹è¿”å›</span><br><span class="line"><span class="keyword">print</span> query2.order_by(User.name).<span class="keyword">all</span>()</span><br><span class="line"><span class="keyword">print</span> query2.order_by(<span class="string">'name'</span>).<span class="keyword">all</span>()</span><br><span class="line"><span class="keyword">print</span> query2.order_by(User.name.desc()).<span class="keyword">all</span>()</span><br><span class="line"><span class="keyword">print</span> query2.order_by(<span class="string">'name desc'</span>).<span class="keyword">all</span>()</span><br><span class="line"><span class="keyword">print</span> session.query(User.id).order_by(User.name.desc(), User.id).<span class="keyword">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> query2.<span class="built_in">filter</span>(User.id == <span class="number">1</span>).scalar() # å¦‚æœæœ‰è®°å½•ï¼Œè¿”å›ç¬¬ä¸€æ¡è®°å½•çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="line"><span class="keyword">print</span> session.query(<span class="string">'id'</span>).select_from(User).<span class="built_in">filter</span>(<span class="string">'id = 1'</span>).scalar()</span><br><span class="line"><span class="keyword">print</span> query2.<span class="built_in">filter</span>(User.id &gt; <span class="number">1</span>, User.name != <span class="string">'a'</span>).scalar() # <span class="built_in">and</span></span><br><span class="line">query3 = query2.<span class="built_in">filter</span>(User.id &gt; <span class="number">1</span>) # å¤šæ¬¡æ‹¼æ¥çš„ <span class="built_in">filter</span> ä¹Ÿæ˜¯ <span class="built_in">and</span></span><br><span class="line">query3 = query3.<span class="built_in">filter</span>(User.name != <span class="string">'a'</span>)</span><br><span class="line"><span class="keyword">print</span> query3.scalar()</span><br><span class="line"><span class="keyword">print</span> query2.<span class="built_in">filter</span>(or_(User.id == <span class="number">1</span>, User.id == <span class="number">2</span>)).<span class="keyword">all</span>() # <span class="built_in">or</span></span><br><span class="line"><span class="keyword">print</span> query2.<span class="built_in">filter</span>(User.id.in_((<span class="number">1</span>, <span class="number">2</span>))).<span class="keyword">all</span>() # in</span><br><span class="line"></span><br><span class="line">query4 = session.query(User.id)</span><br><span class="line"><span class="keyword">print</span> query4.<span class="built_in">filter</span>(User.name == None).scalar()</span><br><span class="line"><span class="keyword">print</span> query4.<span class="built_in">filter</span>(<span class="string">'name is null'</span>).scalar()</span><br><span class="line"><span class="keyword">print</span> query4.<span class="built_in">filter</span>(not_(User.name == None)).<span class="keyword">all</span>() # not</span><br><span class="line"><span class="keyword">print</span> query4.<span class="built_in">filter</span>(User.name != None).<span class="keyword">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> query4.<span class="built_in">count</span>()</span><br><span class="line"><span class="keyword">print</span> session.query(func.<span class="built_in">count</span>(<span class="string">'*'</span>)).select_from(User).scalar()</span><br><span class="line"><span class="keyword">print</span> session.query(func.<span class="built_in">count</span>(<span class="string">'1'</span>)).select_from(User).scalar()</span><br><span class="line"><span class="keyword">print</span> session.query(func.<span class="built_in">count</span>(User.id)).scalar()</span><br><span class="line"><span class="keyword">print</span> session.query(func.<span class="built_in">count</span>(<span class="string">'*'</span>)).<span class="built_in">filter</span>(User.id &gt; <span class="number">0</span>).scalar() # <span class="built_in">filter</span>() ä¸­åŒ…å« Userï¼Œå› æ­¤ä¸éœ€è¦æŒ‡å®šè¡¨</span><br><span class="line"><span class="keyword">print</span> session.query(func.<span class="built_in">count</span>(<span class="string">'*'</span>)).<span class="built_in">filter</span>(User.name == <span class="string">'a'</span>).limit(<span class="number">1</span>).scalar() == <span class="number">1</span> # å¯ä»¥ç”¨ limit() é™åˆ¶ <span class="built_in">count</span>() çš„è¿”å›æ•°</span><br><span class="line"><span class="keyword">print</span> session.query(func.sum(User.id)).scalar()</span><br><span class="line"><span class="keyword">print</span> session.query(func.now()).scalar() # func åå¯ä»¥è·Ÿä»»æ„å‡½æ•°åï¼Œåªè¦è¯¥æ•°æ®åº“æ”¯æŒ</span><br><span class="line"><span class="keyword">print</span> session.query(func.current_timestamp()).scalar()</span><br><span class="line"><span class="keyword">print</span> session.query(func.md5(User.name)).<span class="built_in">filter</span>(User.id == <span class="number">1</span>).scalar()</span><br><span class="line"></span><br><span class="line">query.<span class="built_in">filter</span>(User.id == <span class="number">1</span>).<span class="keyword">update</span>(&#123;User.name: <span class="string">'c'</span>&#125;)</span><br><span class="line">user = query.<span class="built_in">get</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> user.name</span><br><span class="line"></span><br><span class="line">user.name = <span class="string">'d'</span></span><br><span class="line">session.flush() # å†™æ•°æ®åº“ï¼Œä½†å¹¶ä¸æäº¤</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">get</span>(<span class="number">1</span>).name</span><br><span class="line"></span><br><span class="line">session.<span class="keyword">delete</span>(user)</span><br><span class="line">session.flush()</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">get</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">session.rollback()</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">get</span>(<span class="number">1</span>).name</span><br><span class="line">query.<span class="built_in">filter</span>(User.id == <span class="number">1</span>).<span class="keyword">delete</span>()</span><br><span class="line">session.commit()</span><br><span class="line"><span class="keyword">print</span> query.<span class="built_in">get</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>å¢åˆ æ”¹æŸ¥éƒ½æ¶‰åŠåˆ°äº†ï¼Œè‡ªå·±çœ‹çœ‹è¾“å‡ºçš„ SQL è¯­å¥å°±çŸ¥é“äº†ï¼Œäºæ˜¯åŸºç¡€çŸ¥è¯†å°±ä»‹ç»åˆ°æ­¤äº†ã€‚</p>
<p>ä¸‹é¢å¼€å§‹ä»‹ç»ä¸€äº›è¿›é˜¶çš„çŸ¥è¯†ã€‚</p>
<p><strong>å¦‚ä½•æ‰¹é‡æ’å…¥å¤§æ‰¹æ•°æ®ï¼Ÿ</strong><br>å¯ä»¥ä½¿ç”¨é ORM çš„æ–¹å¼ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">session.execute(</span><br><span class="line">    User.__table__.insert(),</span><br><span class="line">    [&#123;<span class="string">'name'</span>: `randint(<span class="number">1</span>, <span class="number">100</span>)`,<span class="string">'age'</span>: randint(<span class="number">1</span>, <span class="number">100</span>)&#125; <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> xrange(<span class="number">10000</span>)]</span><br><span class="line">)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æˆ‘æ‰¹é‡æ’å…¥äº† 10000 æ¡è®°å½•ï¼ŒåŠç§’å†…å°±æ‰§è¡Œå®Œäº†ï¼›è€Œ ORM æ–¹å¼ä¼šèŠ±æ‰å¾ˆé•¿æ—¶é—´ã€‚</p>
<p><strong>å¦‚ä½•è®©æ‰§è¡Œçš„ SQL è¯­å¥å¢åŠ å‰ç¼€ï¼Ÿ</strong><br>ä½¿ç”¨ query å¯¹è±¡çš„ prefix_with() æ–¹æ³•ï¼š<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.query(User.name).prefix_with(<span class="string">'HIGH_PRIORITY'</span>).<span class="keyword">all</span>()</span><br><span class="line">session.<span class="keyword">execute</span>(User.__table__.<span class="keyword">insert</span>().prefix_with(<span class="string">'IGNORE'</span>), &#123;<span class="string">'id'</span>: <span class="number">1</span>, <span class="string">'name'</span>: <span class="string">'1'</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p><strong>å¦‚ä½•æ›¿æ¢ä¸€ä¸ªå·²æœ‰ä¸»é”®çš„è®°å½•ï¼Ÿ</strong><br>ä½¿ç”¨ session.merge() æ–¹æ³•æ›¿ä»£ session.add()ï¼Œå…¶å®å°±æ˜¯ SELECT + UPDATEï¼š<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">user</span> = <span class="keyword">User</span>(id=<span class="number">1</span>, name=<span class="string">'ooxx'</span>)</span><br><span class="line">session.merge(<span class="keyword">user</span>)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure></p>
<p>æˆ–è€…ä½¿ç”¨ MySQL çš„ INSERT â€¦ ON DUPLICATE KEY UPDATEï¼Œéœ€è¦ç”¨åˆ° @compiles è£…é¥°å™¨ï¼Œæœ‰ç‚¹éš¾æ‡‚ï¼Œè‡ªå·±çœ‹å§ï¼š<a href="http://stackoverflow.com/questions/6611563/sqlalchemy-on-duplicate-key-update" target="_blank" rel="external">ã€ŠSQLAlchemy ON DUPLICATE KEY UPDATEã€‹</a> å’Œ <a href="https://github.com/bedwards/sqlalchemy_mysql_ext/blob/master/duplicate.py" target="_blank" rel="external">sqlalchemy_mysql_ext</a>ã€‚</p>
<p><strong>å¦‚ä½•ä½¿ç”¨æ— ç¬¦å·æ•´æ•°ï¼Ÿ</strong><br>å¯ä»¥ä½¿ç”¨ MySQL çš„æ–¹è¨€ï¼š<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from sqlalchemy.dialects.mysql <span class="keyword">import</span> <span class="built_in">INTEGER</span></span><br><span class="line"></span><br><span class="line">id = Column(<span class="built_in">INTEGER</span>(unsigned=<span class="literal">True</span>), primary_key=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>æ¨¡å‹çš„å±æ€§åéœ€è¦å’Œè¡¨çš„å­—æ®µåä¸ä¸€æ ·æ€ä¹ˆåŠï¼Ÿ</strong><br>å¼€å‘æ—¶é‡åˆ°è¿‡ä¸€ä¸ªå¥‡æ€ªçš„éœ€æ±‚ï¼Œæœ‰ä¸ªå…¶ä»–ç³»ç»Ÿçš„è¡¨é‡ŒåŒ…å«äº†ä¸€ä¸ªâ€œfromâ€å­—æ®µï¼Œè¿™åœ¨ Python é‡Œæ˜¯å…³é”®å­—ï¼Œäºæ˜¯åªèƒ½è¿™æ ·å¤„ç†äº†ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">from_</span> = Column(<span class="string">'from'</span>, CHAR(<span class="number">10</span>))</span><br></pre></td></tr></table></figure></p>
<p><strong><em>å¦‚ä½•è·å–å­—æ®µçš„é•¿åº¦ï¼Ÿ</em></strong><br>Column ä¼šç”Ÿæˆä¸€ä¸ªå¾ˆå¤æ‚çš„å¯¹è±¡ï¼Œæƒ³è·å–é•¿åº¦æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œä»¥ User.name ä¸ºä¾‹ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User<span class="selector-class">.name</span><span class="selector-class">.property</span><span class="selector-class">.columns</span>[<span class="number">0</span>]<span class="selector-class">.type</span><span class="selector-class">.length</span></span><br></pre></td></tr></table></figure></p>
<p><strong>å¦‚ä½•æŒ‡å®šä½¿ç”¨ InnoDBï¼Œä»¥åŠä½¿ç”¨ UTF-8 ç¼–ç ï¼Ÿ</strong><br>æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä¿®æ”¹æ•°æ®åº“çš„é»˜è®¤é…ç½®ã€‚å¦‚æœéè¦åœ¨ä»£ç é‡ŒæŒ‡å®šçš„è¯ï¼Œå¯ä»¥è¿™æ ·ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    __table_args__ = &#123;</span><br><span class="line">        <span class="string">'mysql_engine'</span>: <span class="string">'InnoDB'</span>,</span><br><span class="line">        <span class="string">'mysql_charset'</span>: <span class="string">'utf8'</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>MySQL 5.5 å¼€å§‹æ”¯æŒå­˜å‚¨ 4 å­—èŠ‚çš„ UTF-8 ç¼–ç çš„å­—ç¬¦äº†ï¼ŒiOS é‡Œè‡ªå¸¦çš„ emojiï¼ˆå¦‚ ğŸ å­—ç¬¦ï¼‰å°±å±äºè¿™ç§ã€‚<br>å¦‚æœæ˜¯å¯¹è¡¨æ¥è®¾ç½®çš„è¯ï¼Œå¯ä»¥æŠŠä¸Šé¢ä»£ç ä¸­çš„ utf8 æ”¹æˆ utf8mb4ï¼ŒDB_CONNECT_STRING é‡Œçš„ charset ä¹Ÿè¿™æ ·æ›´æ”¹ã€‚<br>å¦‚æœå¯¹åº“æˆ–å­—æ®µæ¥è®¾ç½®ï¼Œåˆ™è¿˜æ˜¯è‡ªå·±å†™ SQL è¯­å¥æ¯”è¾ƒæ–¹ä¾¿ï¼Œå…·ä½“ç»†èŠ‚å¯å‚è€ƒ<a href="http://mathiasbynens.be/notes/mysql-utf8mb4" target="_blank" rel="external">ã€ŠHow to support full Unicode in MySQL databasesã€‹</a>ã€‚<br>ä¸å»ºè®®å…¨ç”¨ utf8mb4 ä»£æ›¿ utf8ï¼Œå› ä¸ºå‰è€…æ›´æ…¢ï¼Œç´¢å¼•ä¼šå ç”¨æ›´å¤šç©ºé—´ã€‚</p>
<p><strong>å¦‚ä½•è®¾ç½®å¤–é”®çº¦æŸï¼Ÿ</strong><br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="title">from</span> sqlalchemy <span class="keyword">import</span> ForeignKey</span><br><span class="line"><span class="class"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="type">User</span>(<span class="type">BaseModel</span>):</span><br><span class="line">    __tablename__ = 'user'</span><br><span class="line"></span><br><span class="line">    id = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="title">primary_key</span>=<span class="type">True</span>)</span><br><span class="line">    age = <span class="type">Column</span>(<span class="type">Integer</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="type">Friendship</span>(<span class="type">BaseModel</span>):</span><br><span class="line">    __tablename__ = 'friendship'</span><br><span class="line"></span><br><span class="line">    id = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="title">primary_key</span>=<span class="type">True</span>)</span><br><span class="line">    user_id1 = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>))</span><br><span class="line">    user_id2 = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in xrange(100):</span><br><span class="line">    session.add(<span class="type">User</span>(<span class="title">age</span>=<span class="title">randint</span>(1, 100)))</span><br><span class="line">session.flush() # æˆ– session.commit()ï¼Œæ‰§è¡Œå®Œåï¼Œuser å¯¹è±¡çš„ id å±æ€§æ‰å¯ä»¥è®¿é—®ï¼ˆå› ä¸º id æ˜¯è‡ªå¢çš„ï¼‰</span><br><span class="line"></span><br><span class="line">for i in xrange(100):</span><br><span class="line">    session.add(<span class="type">Friendship</span>(<span class="title">user_id1</span>=<span class="title">randint</span>(1, 100), user_id2=randint(1, 100)))</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line">session.query(<span class="type">User</span>).filter(<span class="type">User</span>.<span class="title">age</span> &lt; 50).delete()</span></span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œè¿™æ®µä»£ç æ—¶ï¼Œä½ åº”è¯¥ä¼šé‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlalchemy.exc.IntegrityError: (IntegrityError) (1451, 'Cannot <span class="keyword">delete</span> <span class="keyword">or</span> <span class="keyword">update</span> a <span class="keyword">parent</span> <span class="keyword">row</span>: a foreign <span class="keyword">key</span> <span class="keyword">constraint</span> fails (<span class="string">`ooxx`</span>.<span class="string">`friendship`</span>, <span class="keyword">CONSTRAINT</span> <span class="string">`friendship_ibfk_1`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`user_id1`</span>) <span class="keyword">REFERENCES</span> <span class="string">`user`</span> (<span class="string">`id`</span>))<span class="string">') '</span><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> user.age &lt; %s<span class="string">' (50,)</span></span><br></pre></td></tr></table></figure></p>
<p>åŸå› æ˜¯åˆ é™¤ user è¡¨çš„æ•°æ®ï¼Œå¯èƒ½ä¼šå¯¼è‡´ friendship çš„å¤–é”®ä¸æŒ‡å‘ä¸€ä¸ªçœŸå®å­˜åœ¨çš„è®°å½•ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQL ä¼šæ‹’ç»è¿™ç§æ“ä½œï¼Œä¹Ÿå°±æ˜¯ RESTRICTã€‚InnoDB è¿˜å…è®¸æŒ‡å®š ON DELETE ä¸º CASCADE å’Œ SET NULLï¼Œå‰è€…ä¼šåˆ é™¤ friendship ä¸­æ— æ•ˆçš„è®°å½•ï¼Œåè€…ä¼šå°†è¿™äº›è®°å½•çš„å¤–é”®è®¾ä¸º NULLã€‚<br>é™¤äº†åˆ é™¤ï¼Œè¿˜æœ‰å¯èƒ½æ›´æ”¹ä¸»é”®ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´ friendship çš„å¤–é”®å¤±æ•ˆã€‚äºæ˜¯ç›¸åº”çš„å°±æœ‰ ON UPDATE äº†ã€‚å…¶ä¸­ CASCADE å˜æˆäº†æ›´æ–°ç›¸åº”çš„å¤–é”®ï¼Œè€Œä¸æ˜¯åˆ é™¤ã€‚<br>è€Œåœ¨ SQLAlchemy ä¸­æ˜¯è¿™æ ·å¤„ç†çš„ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Friendship</span>(<span class="type">BaseModel</span>):</span><br><span class="line">    __tablename__ = 'friendship'</span><br><span class="line"></span><br><span class="line">    id = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="title">primary_key</span>=<span class="type">True</span>)</span><br><span class="line">    user_id1 = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>, <span class="title">ondelete</span>='<span class="type">CASCADE</span>', <span class="title">onupdate</span>='<span class="type">CASCADE</span>'))</span><br><span class="line">    user_id2 = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>, <span class="title">ondelete</span>='<span class="type">CASCADE</span>', <span class="title">onupdate</span>='<span class="type">CASCADE</span>'))</span></span><br></pre></td></tr></table></figure></p>
<p><strong>å¦‚ä½•è¿æ¥è¡¨ï¼Ÿ</strong><br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy import distinct</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm import aliased</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Friend = aliased(<span class="keyword">User</span>, name='Friend')</span><br><span class="line"></span><br><span class="line">print session.query(<span class="keyword">User</span>.id).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).all() <span class="comment"># æ‰€æœ‰æœ‰æœ‹å‹çš„ç”¨æˆ·</span></span><br><span class="line">print session.query(distinct(<span class="keyword">User</span>.id)).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).all() <span class="comment"># æ‰€æœ‰æœ‰æœ‹å‹çš„ç”¨æˆ·ï¼ˆå»æ‰é‡å¤çš„ï¼‰</span></span><br><span class="line">print session.query(<span class="keyword">User</span>.id).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).distinct().all() <span class="comment"># åŒä¸Š</span></span><br><span class="line">print session.query(Friendship.user_id2).join(<span class="keyword">User</span>, <span class="keyword">User</span>.id == Friendship.user_id1).order_by(Friendship.user_id2).distinct().all() <span class="comment"># æ‰€æœ‰è¢«åˆ«äººå½“æˆæœ‹å‹çš„ç”¨æˆ·</span></span><br><span class="line">print session.query(Friendship.user_id2).select_from(<span class="keyword">User</span>).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).order_by(Friendship.user_id2).distinct().all() <span class="comment"># åŒä¸Šï¼Œjoin çš„æ–¹å‘ç›¸åï¼Œä½†å› ä¸ºä¸æ˜¯ STRAIGHT_JOINï¼Œæ‰€ä»¥ MySQL å¯ä»¥è‡ªå·±é€‰æ‹©é¡ºåº</span></span><br><span class="line">print session.query(<span class="keyword">User</span>.id, Friendship.user_id2).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).all() <span class="comment"># ç”¨æˆ·åŠå…¶æœ‹å‹</span></span><br><span class="line">print session.query(<span class="keyword">User</span>.id, Friendship.user_id2).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).filter(<span class="keyword">User</span>.id &lt; 10).all() <span class="comment"># id å°äº 10 çš„ç”¨æˆ·åŠå…¶æœ‹å‹</span></span><br><span class="line">print session.query(<span class="keyword">User</span>.id, Friend.id).join(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).join(Friend, Friend.id == Friendship.user_id2).all() <span class="comment"># ä¸¤æ¬¡ joinï¼Œç”±äºä½¿ç”¨åˆ°ç›¸åŒçš„è¡¨ï¼Œå› æ­¤éœ€è¦åˆ«å</span></span><br><span class="line">print session.query(<span class="keyword">User</span>.id, Friendship.user_id2).outerjoin(Friendship, <span class="keyword">User</span>.id == Friendship.user_id1).all() <span class="comment"># ç”¨æˆ·åŠå…¶æœ‹å‹ï¼ˆæ— æœ‹å‹åˆ™ä¸º Noneï¼Œä½¿ç”¨å·¦è¿æ¥ï¼‰</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæˆ‘æ²¡æåˆ° relationshipï¼Œè™½ç„¶å®ƒçœ‹ä¸Šå»å¾ˆæ–¹ä¾¿ï¼Œä½†éœ€è¦å­¦ä¹ çš„å†…å®¹å®åœ¨å¤ªå¤šï¼Œè¿˜è¦è€ƒè™‘å¾ˆå¤šæ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œæ‰€ä»¥å¹²è„†è‡ªå·± join å§ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ— æ³•åˆ é™¤ in æ“ä½œæŸ¥è¯¢å‡ºæ¥çš„è®°å½•ï¼Ÿ<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">session</span><span class="selector-class">.query</span>(<span class="selector-tag">User</span>)<span class="selector-class">.filter</span>(<span class="selector-tag">User</span><span class="selector-class">.id</span><span class="selector-class">.in_</span>((1, 2, 3)))<span class="selector-class">.delete</span>()</span><br></pre></td></tr></table></figure></p>
<p>æŠ›å‡ºè¿™æ ·çš„å¼‚å¸¸ï¼š<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlalchemy.exc.InvalidRequestError: Could <span class="keyword">not</span> evaluate current criteria <span class="keyword">in</span> Python.  Specify <span class="symbol">'fetch</span>' <span class="keyword">or</span> <span class="literal">False</span> <span class="keyword">for</span> the synchronize_session parameter.</span><br></pre></td></tr></table></figure></p>
<p>ä½†è¿™æ ·æ˜¯æ²¡é—®é¢˜çš„ï¼š<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(<span class="keyword">User</span>).filter(or_(<span class="keyword">User</span>.id == 1, <span class="keyword">User</span>.id == 2, <span class="keyword">User</span>.id == 3)).delete()</span><br></pre></td></tr></table></figure></p>
<p>æœäº†ä¸‹æ‰¾åˆ°<a href="http://stackoverflow.com/questions/7892618/sqlalchemy-delete-subquery" target="_blank" rel="external">ã€ŠSqlalchemy delete subqueryã€‹</a>è¿™ä¸ªé—®é¢˜ï¼Œæåˆ°äº† <a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/query.html#sqlalchemy.orm.query.Query.delete" target="_blank" rel="external">delete </a>çš„ä¸€ä¸ªæ³¨æ„ç‚¹ï¼šåˆ é™¤è®°å½•æ—¶ï¼Œé»˜è®¤ä¼šå°è¯•åˆ é™¤ session ä¸­ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ï¼Œè€Œ in æ“ä½œä¼°è®¡è¿˜ä¸æ”¯æŒï¼Œäºæ˜¯å°±å‡ºé”™äº†ã€‚è§£å†³åŠæ³•å°±æ˜¯åˆ é™¤æ—¶ä¸è¿›è¡ŒåŒæ­¥ï¼Œç„¶åå†è®© session é‡Œçš„æ‰€æœ‰å®ä½“éƒ½è¿‡æœŸï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session<span class="selector-class">.query</span>(User)<span class="selector-class">.filter</span>(User.id.in_((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)))<span class="selector-class">.delete</span>(synchronize_session=False)</span><br><span class="line"><span class="selector-tag">session</span><span class="selector-class">.commit</span>() # <span class="selector-tag">or</span> <span class="selector-tag">session</span><span class="selector-class">.expire_all</span>()</span><br></pre></td></tr></table></figure></p>
<p>æ­¤å¤–ï¼Œupdate æ“ä½œä¹Ÿæœ‰åŒæ ·çš„å‚æ•°ï¼Œå¦‚æœåé¢ç«‹åˆ»æäº¤äº†ï¼Œé‚£ä¹ˆåŠ ä¸Š synchronize_session=False å‚æ•°ä¼šæ›´å¿«ã€‚</p>
<p><strong>å¦‚ä½•æ‰©å……æ¨¡å‹çš„åŸºç±»ï¼Ÿ</strong><br>declarative_base() ä¼šç”Ÿæˆä¸€ä¸ª class å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çš„å­ç±»ä¸€èˆ¬éƒ½å’Œä¸€å¼ è¡¨å¯¹åº”ã€‚å¦‚æœæƒ³å¢åŠ è¿™ä¸ªåŸºç±»çš„æ–¹æ³•æˆ–å±æ€§ï¼Œè®©å­ç±»éƒ½èƒ½ä½¿ç”¨ï¼Œå¯ä»¥æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p>
<p>1.å®šä¹‰ä¸€ä¸ªæ–°ç±»ï¼Œå°†å®ƒçš„æ–¹æ³•è®¾ç½®ä¸ºåŸºç±»çš„æ–¹æ³•ï¼š<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">class ModelMixin(object):</span><br><span class="line">    @classmethod</span><br><span class="line">    def get_by_id(cls, session, id, columns=None, lock_mode=None):</span><br><span class="line">        <span class="keyword">if</span> hasattr(cls, <span class="string">'id'</span>):</span><br><span class="line">            <span class="keyword">scalar</span> = False</span><br><span class="line">            if <span class="comment">columns:</span></span><br><span class="line">                if <span class="comment">isinstance(columns, (tuple, list)):</span></span><br><span class="line">                    query <span class="comment">= session.query(*columns)</span></span><br><span class="line">                else:</span><br><span class="line">                    <span class="keyword">scalar</span> <span class="comment">= True</span></span><br><span class="line">                    query <span class="comment">= session.query(columns)</span></span><br><span class="line">            else:</span><br><span class="line">                query <span class="comment">= session.query(cls)</span></span><br><span class="line">            if <span class="comment">lock_mode:</span></span><br><span class="line">                query <span class="comment">= query.with_lockmode(lock_mode)</span></span><br><span class="line">            query <span class="comment">= query.filter(cls.id == id)</span></span><br><span class="line">            if <span class="comment">scalar:</span></span><br><span class="line">                return <span class="comment">query.scalar()</span></span><br><span class="line">            return <span class="comment">query.first()</span></span><br><span class="line">        return <span class="comment">None</span></span><br><span class="line">    BaseModel.get_by_id <span class="comment">= get_by_id</span></span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def <span class="comment">get_all(cls, session, columns=None, offset=None, limit=None, order_by=None, lock_mode=None):</span></span><br><span class="line">        if <span class="comment">columns:</span></span><br><span class="line">            if <span class="comment">isinstance(columns, (tuple, list)):</span></span><br><span class="line">                query <span class="comment">= session.query(*columns)</span></span><br><span class="line">            else:</span><br><span class="line">                query <span class="comment">= session.query(columns)</span></span><br><span class="line">                if <span class="comment">isinstance(columns, str):</span></span><br><span class="line">                    query <span class="comment">= query.select_from(cls)</span></span><br><span class="line">        else:</span><br><span class="line">            query <span class="comment">= session.query(cls)</span></span><br><span class="line">        if <span class="comment">order_by is not None:</span></span><br><span class="line">            if <span class="comment">isinstance(order_by, (tuple, list)):</span></span><br><span class="line">                query <span class="comment">= query.order_by(*order_by)</span></span><br><span class="line">            else:</span><br><span class="line">                query <span class="comment">= query.order_by(order_by)</span></span><br><span class="line">        if <span class="comment">offset:</span></span><br><span class="line">            query <span class="comment">= query.offset(offset)</span></span><br><span class="line">        if <span class="comment">limit:</span></span><br><span class="line">            query <span class="comment">= query.limit(limit)</span></span><br><span class="line">        if <span class="comment">lock_mode:</span></span><br><span class="line">            query <span class="comment">= query.with_lockmode(lock_mode)</span></span><br><span class="line">        return <span class="comment">query.all()</span></span><br><span class="line">    BaseModel.get_all <span class="comment">= get_all</span></span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def <span class="comment">count_all(cls, session, lock_mode=None):</span></span><br><span class="line">        query <span class="comment">= session.query(func.count(</span><span class="comment">'*'</span><span class="comment">)).select_from(cls)</span></span><br><span class="line">        if <span class="comment">lock_mode:</span></span><br><span class="line">            query <span class="comment">= query.with_lockmode(lock_mode)</span></span><br><span class="line">        return <span class="comment">query.scalar()</span></span><br><span class="line">    BaseModel.count_all <span class="comment">= count_all</span></span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def <span class="comment">exist(cls, session, id, lock_mode=None):</span></span><br><span class="line">        if <span class="comment">hasattr(cls,</span> <span class="comment">'id'</span><span class="comment">):</span></span><br><span class="line">            query <span class="comment">= session.query(func.count(</span><span class="comment">'*'</span><span class="comment">)).select_from(cls).filter(cls.id == id)</span></span><br><span class="line">            if <span class="comment">lock_mode:</span></span><br><span class="line">                query <span class="comment">= query.with_lockmode(lock_mode)</span></span><br><span class="line">            return <span class="comment">query.scalar() &gt; 0</span></span><br><span class="line">        return <span class="comment">False</span></span><br><span class="line">    BaseModel.exist <span class="comment">= exist</span></span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def <span class="comment">set_attr(cls, session, id, attr, value):</span></span><br><span class="line">        if <span class="comment">hasattr(cls,</span> <span class="comment">'id'</span><span class="comment">):</span></span><br><span class="line">            session.query(cls).filter(cls.id <span class="comment">== id).update(&#123;</span></span><br><span class="line">                attr: value</span><br><span class="line">            &#125;)</span><br><span class="line">            session.commit()</span><br><span class="line">    BaseModel.set_attr <span class="comment">= set_attr</span></span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def <span class="comment">set_attrs(cls, session, id, attrs):</span></span><br><span class="line">        if <span class="comment">hasattr(cls,</span> <span class="comment">'id'</span><span class="comment">):</span></span><br><span class="line">            session.query(cls).filter(cls.id <span class="comment">== id).update(attrs)</span></span><br><span class="line">            session.commit()</span><br><span class="line">    BaseModel.set_attrs <span class="comment">= set_attrs</span></span><br></pre></td></tr></table></figure></p>
<pre><code>è™½ç„¶å¾ˆæ‹™åŠ£ï¼Œä½†ç¡®å®èƒ½ç”¨ã€‚é¡ºä¾¿è¿˜é™„é€äº†ä¸€äº›æœ‰ç”¨çš„ç©æ„ï¼Œä½ æ‡‚çš„ã€‚
</code></pre><p>2.è®¾ç½® declarative_base() çš„ cls å‚æ•°ï¼š</p>
<pre><code>BaseModel = declarative_base(cls=ModelMixin)

è¿™ç§æ–¹æ³•ä¸éœ€è¦æ‰§è¡Œâ€œBaseModel.get_by_id = get_by_idâ€ä¹‹ç±»çš„ä»£ç ã€‚ä¸è¶³ä¹‹å¤„å°±æ˜¯ PyCharm ä»ç„¶æ— æ³•æ‰¾åˆ°è¿™äº›æ–¹æ³•çš„ä½ç½®ã€‚
è®¾ç½® __abstract__ å±æ€§ï¼š

class BaseModel(BaseModel):
    __abstract__ = True
    __table_args__ = { # å¯ä»¥çœæ‰å­ç±»çš„ __table_args__ äº†
        &apos;mysql_engine&apos;: &apos;InnoDB&apos;,
        &apos;mysql_charset&apos;: &apos;utf8&apos;
    }
    # ...

è¿™ç§æ–¹æ³•æœ€ç®€å•ï¼Œä¹Ÿå¯ä»¥ç»§æ‰¿å‡ºå¤šä¸ªç±»ã€‚
</code></pre><p>3.å¦‚ä½•æ­£ç¡®ä½¿ç”¨äº‹åŠ¡ï¼Ÿ<br>å‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„é“¶è¡Œç³»ç»Ÿï¼Œä¸€å…±ä¸¤åç”¨æˆ·ï¼š<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">User</span>(<span class="type">BaseModel</span>):</span><br><span class="line">    __tablename__ = 'user'</span><br><span class="line"></span><br><span class="line">    id = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="title">primary_key</span>=<span class="type">True</span>)</span><br><span class="line">    money = <span class="type">Column</span>(<span class="type">DECIMAL</span>(10, 2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="type">TanseferLog</span>(<span class="type">BaseModel</span>):</span><br><span class="line">    __tablename__ = 'tansefer_log'</span><br><span class="line"></span><br><span class="line">    id = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="title">primary_key</span>=<span class="type">True</span>)</span><br><span class="line">    from_user = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>, <span class="title">ondelete</span>='<span class="type">CASCADE</span>', <span class="title">onupdate</span>='<span class="type">CASCADE</span>'))</span><br><span class="line">    to_user = <span class="type">Column</span>(<span class="type">Integer</span>, <span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>, <span class="title">ondelete</span>='<span class="type">CASCADE</span>', <span class="title">onupdate</span>='<span class="type">CASCADE</span>'))</span><br><span class="line">    amount = <span class="type">Column</span>(<span class="type">DECIMAL</span>(10, 2))</span><br><span class="line"></span><br><span class="line">user = <span class="type">User</span>(<span class="title">money</span>=100)</span><br><span class="line">session.add(<span class="title">user</span>)</span><br><span class="line">user = <span class="type">User</span>(<span class="title">money</span>=0)</span><br><span class="line">session.add(<span class="title">user</span>)</span><br><span class="line">session.commit()</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå¼€ä¸¤ä¸ª sessionï¼ŒåŒæ—¶è¿›è¡Œä¸¤æ¬¡è½¬è´¦æ“ä½œï¼š<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">session1</span> = DB_Session()</span><br><span class="line"><span class="attr">session2</span> = DB_Session()</span><br><span class="line"></span><br><span class="line"><span class="attr">user1</span> = session1.query(User).get(<span class="number">1</span>)</span><br><span class="line"><span class="attr">user2</span> = session1.query(User).get(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> user1.money &gt;= <span class="number">100</span>:</span><br><span class="line">    user1.money <span class="attr">-=</span> <span class="number">100</span></span><br><span class="line">    user2.money += <span class="number">100</span></span><br><span class="line">    session1.add(TanseferLog(<span class="attr">from_user=1,</span> <span class="attr">to_user=2,</span> <span class="attr">amount=100))</span></span><br><span class="line"></span><br><span class="line"><span class="attr">user1</span> = session2.query(User).get(<span class="number">1</span>)</span><br><span class="line"><span class="attr">user2</span> = session2.query(User).get(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> user1.money &gt;= <span class="number">100</span>:</span><br><span class="line">    user1.money <span class="attr">-=</span> <span class="number">100</span></span><br><span class="line">    user2.money += <span class="number">100</span></span><br><span class="line">    session2.add(TanseferLog(<span class="attr">from_user=1,</span> <span class="attr">to_user=2,</span> <span class="attr">amount=100))</span></span><br><span class="line"></span><br><span class="line">session1.commit()</span><br><span class="line">session2.commit()</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨çœ‹çœ‹ç»“æœï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; user1<span class="selector-class">.money</span></span><br><span class="line"><span class="function"><span class="title">Decimal</span><span class="params">(<span class="string">'0.00'</span>)</span></span></span><br><span class="line">&gt;&gt;&gt; user2<span class="selector-class">.money</span></span><br><span class="line"><span class="function"><span class="title">Decimal</span><span class="params">(<span class="string">'100.00'</span>)</span></span></span><br><span class="line">&gt;&gt;&gt; session.query(TanseferLog).count()</span><br><span class="line"><span class="number">2</span>L</span><br></pre></td></tr></table></figure></p>
<p>ä¸¤æ¬¡è½¬è´¦éƒ½æˆåŠŸäº†ï¼Œä½†æ˜¯åªè½¬èµ°äº†ä¸€ç¬”é’±ï¼Œè¿™æ˜æ˜¾ä¸ç§‘å­¦ã€‚</p>
<p>å¯è§ MySQL InnoDB è™½ç„¶æ”¯æŒäº‹åŠ¡ï¼Œä½†å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•çš„ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨åŠ é”ã€‚<br>é¦–å…ˆæ¥è¯•è¯•è¯»é”ï¼š<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user1 = session1.query(User).with_lockmode(<span class="string">'read'</span>).get(<span class="number">1</span>)</span><br><span class="line">user2 = session1.query(User).with_lockmode(<span class="string">'read'</span>).get(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> user1.money &gt;= <span class="number">100</span>:</span><br><span class="line">    user1.money -= 100</span><br><span class="line">    user2.money += 100</span><br><span class="line">    session1.add(TanseferLog(from_user=1, to_user=2, amount=100))</span><br><span class="line"></span><br><span class="line">user1 = session2.query(User).with_lockmode('read').<span class="keyword">get</span>(1)</span><br><span class="line">user2 = session2.query(User).with_lockmode('read').<span class="keyword">get</span>(2)</span><br><span class="line"><span class="keyword">if</span> user1.money &gt;= 100:</span><br><span class="line">    user1.money -= 100</span><br><span class="line">    user2.money += 100</span><br><span class="line">    session2.add(TanseferLog(from_user=1, to_user=2, amount=100))</span><br><span class="line">session1.commit()</span><br><span class="line">session2.commit()</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨åœ¨æ‰§è¡Œ session1.commit() çš„æ—¶å€™ï¼Œå› ä¸º user1 å’Œ user2 éƒ½è¢« session2 åŠ äº†è¯»é”ï¼Œæ‰€ä»¥ä¼šç­‰å¾…é”è¢«é‡Šæ”¾ã€‚è¶…æ—¶ä»¥åï¼Œsession1.commit() ä¼šæŠ›å‡ºä¸ªè¶…æ—¶çš„å¼‚å¸¸ï¼Œå¦‚æœæ•æ‰äº†çš„è¯ï¼Œæˆ–è€… session2 åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆ session2.commit() è¿˜æ˜¯èƒ½æ­£å¸¸æäº¤çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä¸ªäº‹åŠ¡æ˜¯è‚¯å®šä¼šæäº¤å¤±è´¥çš„ï¼Œæ‰€ä»¥é‚£äº›æ›´æ”¹ç­‰äºç™½åšäº†ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹å†™é”ï¼ŒæŠŠä¸Šæ®µä»£ç ä¸­çš„ â€˜readâ€™ æ”¹æˆ â€˜updateâ€™ å³å¯ã€‚è¿™æ¬¡åœ¨æ‰§è¡Œ select çš„æ—¶å€™å°±ä¼šè¢«é˜»å¡äº†ï¼š<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user<span class="number">1</span> = sessio<span class="symbol">n2</span>.query<span class="comment">(User)</span>.with_lockmode<span class="comment">('update')</span>.get<span class="comment">(1)</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·åªè¦åœ¨è¶…æ—¶æœŸé—´å†…ï¼Œsession1 å®Œæˆäº†æäº¤æˆ–å›æ»šï¼Œé‚£ä¹ˆ session2 å°±èƒ½æ­£å¸¸åˆ¤æ–­ user1.money &gt;= 100 æ˜¯å¦æˆç«‹äº†ã€‚<br>ç”±æ­¤å¯è§ï¼Œå¦‚æœéœ€è¦æ›´æ”¹æ•°æ®ï¼Œæœ€å¥½åŠ å†™é”ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ç”¨è¯»é”å‘¢ï¼Ÿå¦‚æœè¦ä¿è¯äº‹åŠ¡è¿è¡ŒæœŸé—´å†…ï¼Œè¢«è¯»å–çš„æ•°æ®ä¸è¢«ä¿®æ”¹ï¼Œè‡ªå·±ä¹Ÿä¸å»ä¿®æ”¹ï¼ŒåŠ è¯»é”å³å¯ã€‚<br>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾æˆ‘æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·çš„å¼€æ”¯è®°å½•ï¼ˆåŒæ—¶åŒ…å«ä½™é¢å’Œè½¬è´¦è®°å½•ï¼‰ï¼Œå¯ä»¥ç›´æ¥æŠŠ user å’Œ tansefer_log åšä¸ªå†…è¿æ¥ã€‚<br>ä½†å¦‚æœç”¨æˆ·çš„è½¬è´¦è®°å½•ç‰¹åˆ«å¤šï¼Œæˆ‘åœ¨æŸ¥è¯¢å‰æƒ³å…ˆéªŒè¯ç”¨æˆ·çš„å¯†ç ï¼ˆå‡è®¾åœ¨ user è¡¨ä¸­ï¼‰ï¼Œç¡®è®¤ç›¸ç¬¦åæ‰æŸ¥è¯¢è½¬è´¦è®°å½•ã€‚è€Œè¿™ä¸¤æ¬¡æŸ¥è¯¢çš„æœŸé—´å†…ï¼Œç”¨æˆ·å¯èƒ½æ”¶åˆ°äº†ä¸€ç¬”è½¬è´¦ï¼Œå¯¼è‡´ä»–çš„ money å­—æ®µè¢«ä¿®æ”¹äº†ï¼Œä½†æˆ‘åœ¨å±•ç¤ºç»™ç”¨æˆ·æ—¶ï¼Œç”¨æˆ·çš„ä½™é¢ä»ç„¶æ²¡å˜ï¼Œè¿™å°±ä¸æ­£å¸¸äº†ã€‚<br>è€Œå¦‚æœæˆ‘åœ¨è¯»å– user æ—¶åŠ äº†è¯»é”ï¼Œç”¨æˆ·æ˜¯æ— æ³•æ”¶åˆ°è½¬è´¦çš„ï¼ˆå› ä¸ºæ— æ³•è¢«å¦ä¸€ä¸ªäº‹åŠ¡åŠ å†™é”æ¥ä¿®æ”¹ money å­—æ®µï¼‰ï¼Œè¿™å°±ä¿è¯äº†ä¸ä¼šæŸ¥å‡ºé¢å¤–çš„ tansefer_log è®°å½•ã€‚ç­‰æˆ‘æŸ¥è¯¢å®Œä¸¤å¼ è¡¨ï¼Œé‡Šæ”¾äº†è¯»é”åï¼Œè½¬è´¦å°±å¯ä»¥ç»§ç»­è¿›è¡Œäº†ï¼Œä¸è¿‡æˆ‘æ˜¾ç¤ºçš„æ•°æ®åœ¨å½“æ—¶çš„ç¡®æ˜¯æ­£ç¡®å’Œä¸€è‡´çš„ã€‚</p>
<p>å¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¢«æŸ¥è¯¢çš„å­—æ®µæ²¡æœ‰åŠ ç´¢å¼•çš„è¯ï¼Œå°±ä¼šå˜æˆé”æ•´å¼ è¡¨äº†ï¼š<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sessio<span class="symbol">n1</span>.query<span class="comment">(User)</span>.filter<span class="comment">(User.id &gt; 50)</span>.with_lockmode<span class="comment">('update')</span>.all<span class="comment">()</span></span><br><span class="line">sessio<span class="symbol">n2</span>.query<span class="comment">(User)</span>.filter<span class="comment">(User.id &lt; 40)</span>.with_lockmode<span class="comment">('update')</span>.all<span class="comment">()</span> <span class="attr"># ä¸ä¼šè¢«é”ï¼Œå› ä¸º id æ˜¯ä¸»é”®</span><br><span class="line"></span><br><span class="line">session1</span>.rollback<span class="comment">()</span></span><br><span class="line">sessio<span class="symbol">n2</span>.rollback<span class="comment">()</span></span><br><span class="line"></span><br><span class="line">sessio<span class="symbol">n1</span>.query<span class="comment">(User)</span>.filter<span class="comment">(User.money == 50)</span>.with_lockmode<span class="comment">('update')</span>.all<span class="comment">()</span></span><br><span class="line">sessio<span class="symbol">n2</span>.query<span class="comment">(User)</span>.filter<span class="comment">(User.money == 40)</span>.with_lockmode<span class="comment">('update')</span>.all<span class="comment">()</span> <span class="attr"># ä¼šç­‰å¾…è§£é”ï¼Œå› ä¸º money ä¸Šæ²¡æœ‰ç´¢å¼•</span></span><br></pre></td></tr></table></figure></p>
<p>è¦é¿å…çš„è¯ï¼Œå¯ä»¥è¿™æ ·ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">money</span> = Column(DECIMAL(<span class="number">10</span>, <span class="number">2</span>), index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></p>
<p>å¦ä¸€ä¸ªæ³¨æ„ç‚¹æ˜¯å­äº‹åŠ¡ã€‚<br>InnoDB æ”¯æŒå­äº‹åŠ¡ï¼ˆsavepoint è¯­å¥ï¼‰ï¼Œå¯ä»¥ç®€åŒ–ä¸€äº›é€»è¾‘ã€‚<br>ä¾‹å¦‚æœ‰çš„æ–¹æ³•æ˜¯ç”¨äºæ”¹å†™æ•°æ®åº“çš„ï¼Œå®ƒæ‰§è¡Œæ—¶å¯èƒ½æäº¤äº†äº‹åŠ¡ï¼Œä½†åœ¨åç»­çš„æµç¨‹ä¸­å´æ‰§è¡Œå¤±è´¥äº†ï¼Œå´æ²¡æ³•å›æ»šé‚£ä¸ªæ–¹æ³•ä¸­å·²ç»æäº¤çš„äº‹åŠ¡ã€‚è¿™æ—¶å°±å¯ä»¥æŠŠé‚£ä¸ªæ–¹æ³•å½“æˆå­äº‹åŠ¡æ¥è¿è¡Œäº†ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">if</span> success:</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    session.rollback()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">if</span> success:</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    session.rollback()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">session.begin_nested()</span><br><span class="line"><span class="keyword">if</span> step1():</span><br><span class="line">    session.begin_nested()</span><br><span class="line">    <span class="keyword">if</span> step2():</span><br><span class="line">        session.commit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session.rollback()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    session.rollback()</span><br></pre></td></tr></table></figure></p>
<p>æ­¤å¤–ï¼Œrollback ä¸€ä¸ªå­äº‹åŠ¡ï¼Œå¯ä»¥é‡Šæ”¾è¿™ä¸ªå­äº‹åŠ¡ä¸­è·å¾—çš„é”ï¼Œæé«˜å¹¶å‘æ€§å’Œé™ä½æ­»é”æ¦‚ç‡ã€‚</p>
<p>å¦‚ä½•å¯¹ä¸€ä¸ªå­—æ®µè¿›è¡Œè‡ªå¢æ“ä½œï¼Ÿ<br>æœ€ç®€å•çš„åŠæ³•å°±æ˜¯è·å–æ—¶åŠ ä¸Šå†™é”ï¼š<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">user</span> = session.query(<span class="keyword">User</span>).with_lockmode(<span class="string">'update'</span>).get(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">user</span>.age += 1</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœä¸æƒ³å¤šä¸€æ¬¡è¯»çš„è¯ï¼Œè¿™æ ·å†™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">session.query(<span class="keyword">User</span>).filter(<span class="keyword">User</span>.id == 1).update(&#123;</span><br><span class="line">    <span class="keyword">User</span>.age: <span class="keyword">User</span>.age + 1</span><br><span class="line">&#125;)</span><br><span class="line">session.commit()</span><br><span class="line"><span class="comment"># å…¶å®å­—æ®µä¹‹é—´ä¹Ÿå¯ä»¥åšè¿ç®—ï¼š</span></span><br><span class="line">session.query(<span class="keyword">User</span>).filter(<span class="keyword">User</span>.id == 1).update(&#123;</span><br><span class="line">    <span class="keyword">User</span>.age: <span class="keyword">User</span>.age + <span class="keyword">User</span>.id</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/2015/11/09/ä½¿ç”¨Pythonçš„OpenSSLåº“æ¥è¿›è¡ŒRSAåŠ å¯†/" style="float: left;">
        â† ä½¿ç”¨Pythonçš„OpenSSLåº“æ¥è¿›è¡ŒRSAåŠ å¯†
    </a>
    
    
    <a class="pull-right" href="/2015/10/25/Python-Excel-Tutorial-æŒ‡å—/">
        Python Excel Tutorial æŒ‡å— â†’
    </a>
    
</nav>

        <div class="duoshuo">
<div class="ds-thread" data-thread-key="2015/11/02/SQLAlchemy-ä½¿ç”¨ç»éªŒ/" data-title="SQLAlchemy ä½¿ç”¨ç»éªŒ" data-url="http://yoursite.com/2015/11/02/SQLAlchemy-ä½¿ç”¨ç»éªŒ/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"duoshuo_name"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By é’Ÿè”šè”š. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/cspilgrimzww" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
